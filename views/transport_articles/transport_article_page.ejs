<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title><%= data.title %> | TaiwanMe</title>
    <meta name="description" content="<%= data.intro ? data.intro.substring(0, 150) + '...' : 'Travel guide by TaiwanMe' %>">
    
    <meta property="og:type" content="article">
    <meta property="og:title" content="<%= data.title %>">
    <meta property="og:description" content="<%= data.intro ? data.intro.substring(0, 150) + '...' : '' %>">
    <meta property="og:image" content="<%= data.heroImage %>">
    <meta property="og:url" content="<%= data.currentUrl || '' %>">

    <link rel="icon" href="/image/logo.png" type="image/png">
    
    <link rel="stylesheet" href="/style.css">
    
    <style>
        body { background-color: #f9f9f9; scroll-behavior: smooth; }

        /* Hero Banner */
        .guide-hero {
            position: relative; width: 100%; height: 50vh; min-height: 400px;
            background-size: cover; background-position: center; display: flex; align-items: flex-end;
        }
        .guide-hero::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.7));
        }
        .guide-title-box {
            position: relative; z-index: 2; width: 100%; max-width: 1200px; margin: 0 auto; padding: 40px 20px; color: white;
        }
        .guide-tag {
            background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 4px;
            font-size: 0.9rem; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; display: inline-block;
            font-family: var(--font-eng);
        }
        .guide-title { 
            font-size: 2.8rem; font-weight: 900; margin-bottom: 10px; line-height: 1.2; 
            font-family: var(--font-eng); text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }
        .guide-meta { font-size: 0.95rem; opacity: 0.9; font-family: var(--font-main); }

        /* Banner Credit */
        .banner-credit {
            position: absolute; bottom: 10px; right: 20px; z-index: 5;
            font-size: 0.75rem; color: rgba(255, 255, 255, 0.7);
            background-color: rgba(0, 0, 0, 0.4); padding: 4px 8px; border-radius: 4px;
            max-width: 80%; text-align: right;
        }
        .banner-credit a { color: #fff; text-decoration: underline; }

        /* Layout */
        .guide-container { display: flex; max-width: 1200px; margin: 40px auto; padding: 0 20px; gap: 40px; align-items: flex-start; }
        .guide-sidebar { flex: 0 0 280px; display: none; }
        @media (min-width: 992px) { .guide-sidebar { display: block; } }

        /* TOC */
        .toc-sticky-box {
            position: sticky; top: 100px; background: white; padding: 25px;
            border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
            max-height: 80vh; overflow-y: auto;
        }
        .toc-title { font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; color: #333; font-family: var(--font-eng); }
        .toc-list { list-style: none; padding: 0; margin: 0; }
        .toc-list li { margin-bottom: 10px; }
        .toc-list a {
            text-decoration: none; color: #666; font-size: 0.95rem; transition: 0.3s; display: block;
            border-left: 3px solid transparent; padding-left: 10px; font-family: var(--font-main);
        }
        .toc-list a:hover { color: var(--accent-color); border-left-color: var(--accent-color); }
        
        .toc-list a.active {
            color: var(--accent-color);
            border-left-color: var(--accent-color);
            font-weight: bold;
            background: linear-gradient(90deg, rgba(0,0,0,0.03), transparent);
        }

        /* Content */
        .guide-content { flex: 1; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-width: 0; }
        .section-block { margin-bottom: 60px; scroll-margin-top: 100px; }
        .section-title {
            font-size: 1.8rem; color: #333; margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid #eee; font-family: var(--font-eng); font-weight: 700;
        }
        .guide-text { font-size: 1.05rem; line-height: 1.8; color: #444; margin-bottom: 20px; text-align: justify; font-family: var(--font-main); }
        
        /* Image & Caption */
        .guide-img {
            width: 100%; height: auto; border-radius: 8px; margin-top: 20px; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .zoomable { cursor: zoom-in; transition: transform 0.2s; }
        .zoomable:hover { opacity: 0.9; transform: scale(1.01); }

        .img-caption {
            font-size: 0.85rem; color: #777; text-align: center; margin-bottom: 30px;
            background-color: #f8f9fa; padding: 10px; border-radius: 0 0 8px 8px;
            border: 1px solid #eee; border-top: none; font-family: var(--font-main);
        }
        .img-caption a { color: #555; text-decoration: underline; margin: 0 5px; font-weight: bold; }
        .img-caption a:hover { color: var(--accent-color); }

        /* Lightbox */
        .lightbox {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; cursor: zoom-out;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .lightbox.show { opacity: 1; }
        .lightbox-img { max-width: 95%; max-height: 95%; object-fit: contain; cursor: default; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; }

        /* Tips & Tables */
        .tip-box {
            background-color: #fff8e1; border-left: 5px solid #ffc107; padding: 20px; margin: 25px 0; border-radius: 4px; color: #555;
            font-family: var(--font-main);
        }
        .tip-title { font-weight: bold; color: #d39e00; margin-bottom: 5px; display: block; }
        
        .table-responsive { overflow-x: auto; margin: 25px 0; border-radius: 8px; border: 1px solid #eee; }
        .guide-table { width: 100%; border-collapse: collapse; min-width: 500px; font-family: var(--font-main); }
        .guide-table th { background: #333; color: white; padding: 12px; text-align: left; white-space: nowrap; }
        .guide-table td { padding: 12px; border-bottom: 1px solid #ddd; color: #555; }
        .guide-table tr:hover { background-color: #f5f5f5; }
        .guide-table tr:last-child td { border-bottom: none; }

        @media (max-width: 768px) {
            .guide-container { flex-direction: column; padding: 0 15px; }
            .guide-content { padding: 25px 20px; }
            .guide-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <%- include('../partials/header') %>

    <header class="guide-hero" style="background-image: url('<%= data.heroImage %>');">
        <div class="guide-title-box">
            <span class="guide-tag"><%= data.tag %> Guide</span>
            <h1 class="guide-title"><%= data.title %></h1>
            <div class="guide-meta">Last Updated: <%= data.updatedAt %></div>
        </div>
        
        <% if (data.heroImageCredit) { %>
            <div class="banner-credit">
                <%- data.heroImageCredit %>
            </div>
        <% } %>
    </header>

    <div class="guide-container">
        <aside class="guide-sidebar">
            <div class="toc-sticky-box">
                <div class="toc-title">Table of Contents</div>
                <ul class="toc-list" id="toc-list">
                    <% if (data.sections && data.sections.length > 0) { %>
                        <% data.sections.forEach(function(section) { %>
                            <li><a href="#<%= section.id %>" class="toc-link" data-target="<%= section.id %>"><%= section.heading %></a></li>
                        <% }); %>
                    <% } %>
                </ul>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <a href="/transport" style="text-decoration: none; font-weight: bold; color: #333; font-size: 0.9rem; font-family: var(--font-eng);">‚Üê Back to All Guides</a>
                </div>
            </div>
        </aside>

        <article class="guide-content">
            <% if (data.intro) { %>
                <div class="guide-text" style="font-size: 1.1rem; color: #666; margin-bottom: 40px; font-style: italic;">
                    <%- data.intro %>
                </div>
            <% } %>

            <% if (data.sections && data.sections.length > 0) { %>
                <% data.sections.forEach(function(section) { %>
                    <section id="<%= section.id %>" class="section-block">
                        <h2 class="section-title"><%= section.heading %></h2>
                        
                        <div class="guide-text">
                            <%- section.content %>
                        </div>

                        <% /* ÊÉÖÊ≥Å AÔºöÊñ∞ÁöÑÂ§öÂºµÂúñÁâáÊ®°Âºè (Images Array) */ %>
                        <% if (section.images && section.images.length > 0) { %>
                            <div class="section-gallery">
                                <% section.images.forEach(function(img) { %>
                                    <div class="image-wrapper" style="margin-bottom: 30px;">
                                        <img src="<%= img.path %>" 
                                             alt="<%= section.heading %>" 
                                             class="guide-img zoomable"
                                             data-src="<%= img.path %>"
                                             loading="lazy">
                                        
                                        <div class="img-caption">
                                            Photo Credit: <%= img.credit %>
                                            <% if (img.source_url) { %>
                                                | <a href="<%= img.source_url %>" target="_blank" rel="noopener noreferrer">Official Source üîó</a>
                                            <% } %>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>

                        <% /* ÊÉÖÊ≥Å BÔºöËàäÁöÑÂñÆÂºµÂúñÁâáÊ®°Âºè (Backward Compatibility) */ %>
                        <% } else if (section.image) { %>
                            <img src="<%= section.image %>" 
                                 alt="<%= section.heading %>" 
                                 class="guide-img <%= section.enableZoom ? 'zoomable' : '' %>"
                                 data-src="<%= section.image %>"
                                 loading="lazy"> 
                             
                            <% if (section.links && section.links.length > 0) { %>
                                <div class="img-caption">
                                    Source / Official Info:
                                    <% section.links.forEach(function(link, index) { %>
                                        <% if (index > 0) { %> | <% } %>
                                        <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer">üîó <%= link.text %></a>
                                    <% }); %>
                                </div>
                            <% } %>
                        <% } %>

                        <% if (section.table) { %>
                            <div class="table-responsive">
                                <table class="guide-table">
                                    <thead>
                                        <tr>
                                            <% section.table.headers.forEach(function(th) { %>
                                                <th><%= th %></th>
                                            <% }); %>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% section.table.rows.forEach(function(row) { %>
                                            <tr>
                                                <% row.forEach(function(cell) { %>
                                                    <td><%= cell %></td>
                                                <% }); %>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>

                        <% if (section.tip) { %>
                            <div class="tip-box">
                                <span class="tip-title">üí° Travel Tip:</span>
                                <%= section.tip %>
                            </div>
                        <% } %>
                    </section>
                <% }); %>
            <% } %>
        </article>
    </div>

    <div id="lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-img" id="lightbox-img" src="" alt="Enlarged view">
    </div>

    <%- include('../partials/footer') %>
    
    <script src="/script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lightbox & ScrollSpy Logic
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const closeBtn = document.querySelector('.lightbox-close');
            
            document.querySelectorAll('.zoomable').forEach(img => {
                img.addEventListener('click', function() {
                    lightboxImg.src = this.getAttribute('data-src');
                    lightbox.style.display = 'flex';
                    setTimeout(() => lightbox.classList.add('show'), 10);
                });
            });

            const closeBox = () => { 
                lightbox.classList.remove('show');
                setTimeout(() => lightbox.style.display = 'none', 300);
            };
            
            closeBtn.addEventListener('click', closeBox);
            lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeBox(); });
            document.addEventListener('keydown', (e) => { if (e.key === "Escape" && lightbox.style.display === 'flex') closeBox(); });

            const sections = document.querySelectorAll('.section-block');
            const navLinks = document.querySelectorAll('.toc-link');

            window.addEventListener('scroll', () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= (sectionTop - 150)) { current = section.getAttribute('id'); }
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-target') === current) { link.classList.add('active'); }
                });
            });
        });
    </script>

</body>
</html>