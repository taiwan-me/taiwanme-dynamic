<% 
// --- EJS é‚è¼¯å€ ---
const getActiveStyle = (targetPage) => {
    return (typeof pageName !== 'undefined' && pageName === targetPage) 
        ? 'color: var(--accent-color); font-weight: bold;' 
        : '';
}
const mapLink = (typeof pageName !== 'undefined' && pageName === 'index') ? '#mapSection' : '/#mapSection';
%>

<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/image/logo.png" type="image/png">
<link rel="apple-touch-icon" href="/image/logo.png">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "TaiwanMe",
  "alternateName": ["Taiwan Me", "TaiwanMe Travel"],
  "url": "https://taiwanme-dynamic.vercel.app/"
}
</script>

<style>
    /* ========================================= */
    /* 1. å›åˆ°é ‚éƒ¨æŒ‰éˆ•æ¨£å¼ (ä¿ç•™åŸæ¨£) */
    /* ========================================= */
    #backToTopBtn {
        position: fixed; bottom: 30px; right: 30px; z-index: 9999;
        width: 50px; height: 50px; border: none; border-radius: 50%;
        background-color: var(--accent-color, #e63946); color: white;
        font-size: 1.5rem; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        opacity: 0; visibility: hidden; transform: translateY(20px);
        transition: all 0.4s ease; display: flex; align-items: center; justify-content: center;
    }
    #backToTopBtn.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #backToTopBtn:hover { background-color: #333; transform: translateY(-5px); }
    @media (max-width: 768px) {
        #backToTopBtn { bottom: 20px; right: 20px; width: 45px; height: 45px; font-size: 1.2rem; }
    }

    /* ========================================= */
    /* 2. Search æŒ‰éˆ•æ¨£å¼ */
    /* ========================================= */
    .search-pill-btn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 20px; margin-left: 20px;
        border: 1px solid #333; border-radius: 50px; background: transparent;
        color: #333; font-weight: bold; font-family: inherit; font-size: 0.85rem;
        cursor: pointer; transition: all 0.3s ease;
        text-transform: uppercase; letter-spacing: 0.05em;
    }
    .search-pill-btn:hover { background: #333; color: #fff; }
    @media (max-width: 900px) { .search-pill-btn { display: none; } }

    /* ========================================= */
    /* 3. å…¨è¢å¹•æœå°‹è¦–çª—æ¨£å¼ */
    /* ========================================= */
    .search-modal {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.98);
        z-index: 10000; justify-content: center; align-items: center; flex-direction: column;
        animation: fadeIn 0.3s ease;
    }
    .search-content { text-align: center; width: 100%; max-width: 700px; position: relative; padding: 20px; }
    .search-content h2 { font-size: 2.5rem; color: #333; margin-bottom: 40px; font-family: serif; }
    
    .input-wrapper {
        position: relative; display: flex; align-items: center;
        border-bottom: 2px solid #333; padding-bottom: 10px;
    }
    #modal-search-input { width: 100%; border: none; background: transparent; font-size: 1.5rem; outline: none; color: #333; }
    .submit-search-btn { background: #333; color: white; border: none; padding: 10px 25px; font-size: 1rem; cursor: pointer; text-transform: uppercase; }
    
    .close-search { position: absolute; top: 30px; right: 40px; font-size: 3rem; cursor: pointer; color: #999; }
    .close-search:hover { color: #333; }

    /* æœå°‹çµæœåˆ—è¡¨ */
    .search-results-list { margin-top: 20px; text-align: left; max-height: 50vh; overflow-y: auto; }
    .result-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; text-decoration: none; color: #333; transition: background 0.2s; }
    .result-item:hover { background-color: #f9f9f9; }
    .result-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
    .result-type { font-size: 0.75rem; color: #E8A2A2; font-weight: bold; text-transform: uppercase; }
    .result-title { font-size: 1.1rem; font-weight: bold; }

    /* ========================================= */
    /* 4. Philosophy Modal */
    /* ========================================= */
    .philosophy-modal {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(20, 20, 20, 0.9);
        z-index: 10001; justify-content: center; align-items: center;
        animation: fadeIn 0.4s ease; backdrop-filter: blur(5px);
    }
    .philosophy-card {
        background: #fff; width: 90%; max-width: 650px; max-height: 85vh;
        overflow-y: auto; padding: 50px; position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-radius: 4px;
        text-align: left;
    }
    .philosophy-close {
        position: absolute; top: 20px; right: 25px; font-size: 2rem; 
        cursor: pointer; color: #888; transition: color 0.3s;
        line-height: 1;
    }
    .philosophy-close:hover { color: #000; }
    
    .philo-header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .philo-title { font-family: serif; font-size: 2.2rem; color: #333; margin-bottom: 10px; line-height: 1.2; }
    .philo-subtitle { font-family: sans-serif; font-size: 0.9rem; color: #E8A2A2; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
    
    .philo-body p { 
        font-family: sans-serif; font-size: 1.05rem; line-height: 1.8; color: #555; margin-bottom: 20px; 
    }
    .philo-body strong { color: #000; font-weight: 600; }
    .philo-highlight {
        font-family: serif; font-style: italic; font-size: 1.3rem; color: #333;
        margin: 30px 0; padding-left: 20px; border-left: 4px solid #E8A2A2;
    }

    /* ========================================= */
    /* 5. LOGO å€åŸŸå¾®èª¿ */
    /* ========================================= */
    .brand-title-row { display: flex; align-items: baseline; }
    .brand-zh { 
        font-size: 1.1rem; 
        font-weight: 500; 
        margin-left: 8px; 
        color: #333; 
        letter-spacing: 0.05em;
    }
    @media (max-width: 480px) {
        .brand-zh { font-size: 1rem; margin-left: 5px; }
    }

    @media (max-width: 600px) {
        .philosophy-card { padding: 30px 20px; }
        .philo-title { font-size: 1.8rem; }
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ========================================= */
    /* âœ… ä¿®æ­£é‡é» 1: Header (Logo åˆ—) */
    /* ========================================= */
    /* å¿…é ˆæ˜¯ fixed æ‰èƒ½æ°¸é åœåœ¨è¦–çª—æœ€ä¸Šæ–¹ */
    #header.main-header {
        position: fixed !important; 
        top: 0;
        left: 0;
        width: 100%;
        background: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        z-index: 1002; /* æœ€é«˜å±¤ç´šï¼Œè“‹ä½å°è¦½åˆ— */
        padding: 0; /* padding ç”± inner container æ§åˆ¶ */
        border-bottom: 1px solid #eee; /* ä¿ç•™åŸæœ¬çš„åº•ç·š */
    }

    /* ========================================= */
    /* âœ… ä¿®æ­£é‡é» 2: Desktop Nav (å°è¦½åˆ—) */
    /* ========================================= */
    .desktop-nav {
        /* ä½¿ç”¨åŸæœ¬çš„é¡è‰²è®Šæ•¸ */
        background-color: var(--lace-bg, #F5F3F0); 
        border-top: 2px solid var(--lace-border, #AC9F95);
        border-bottom: 2px solid var(--lace-border, #AC9F95);
        padding: 5px 0;
        margin-top: 0; 

        /* å®šä½è¨­å®š */
        position: fixed; /* å›ºå®šå®šä½ */
        width: 100%;
        left: 0;
        z-index: 1001; /* æ¯” Logo åˆ—ä½ä¸€å±¤ (1001 < 1002) */
        transition: transform 0.3s ease-in-out; /* æ»‘å‹•å‹•ç•« */
        
        /* é è¨­ä½ç½® (JS æœƒç²¾ç¢ºè¨ˆç®—è¦†è“‹æ­¤å€¼) */
        top: 80px; 
    }

    /* éš±è—ç‹€æ…‹ï¼šå¾€ä¸Šç¸®é€²å» (transform Y -100%) */
    /* å› ç‚ºå±¤ç´šæ¯” Header ä½ï¼Œæ‰€ä»¥æœƒçœ‹èµ·ä¾†åƒæ˜¯èº²åˆ° Header å¾Œé¢ */
    .desktop-nav.nav-hidden {
        transform: translateY(-100%);
    }

    /* é¡¯ç¤ºç‹€æ…‹ï¼šå›åˆ°åŸä½ */
    .desktop-nav.nav-visible {
        transform: translateY(0);
    }

    /* ========================================= */
    /* âœ… ä¿®æ­£é‡é» 3: Body Padding */
    /* ========================================= */
    /* é ç•™ç©ºé–“çµ¦å…©å€‹å›ºå®šçš„ Headerï¼Œé¿å…å…§å®¹è¢«é®æ“‹ */
    body {
        padding-top: 140px; /* JS æœƒè‡ªå‹•è¨ˆç®—å¯¦éš›é«˜åº¦ */
    }

</style>

<header id="header" class="main-header">
    <div class="header-container">
        <div class="logo">
            <a href="/" class="logo-link">
                <img src="/image/logo.png" alt="TaiwanMe Logo" class="logo-img">
                <div class="logo-text-group">
                    <div class="brand-title-row">
                        <span class="brand-name">TaiwanMe</span>
                        <span class="brand-zh">å°ç£å‘³</span>
                    </div>
                    <span class="brand-slogan">THE REAL TASTE OF TAIWAN</span>
                </div>
            </a>
        </div>

        <div class="header-links desktop-only" style="display: flex; align-items: center;">
            <a href="#" class="h-link" id="tippingBtn">BUY US<br>A BOBA</a>
            <a href="#" class="h-link philosophy-trigger" id="philosophyBtn">TAIWANME'S<br>PHILOSOPHY</a>
            <a href="#" class="h-link" id="bizInquiryBtn">BUSINESS<br>INQUIRY</a>
            
            <button id="desktop-search-trigger" class="search-pill-btn">
                <span>ğŸ”</span> Search
            </button>
        </div>

        <div class="nav-icons">
            <button id="mobile-search-trigger" class="search-trigger desktop-hidden" style="background:none; border:none; font-size:1.2rem; cursor:pointer; display:none;">
                ğŸ”
            </button>
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </div>
</header>

<div id="philosophyModal" class="philosophy-modal">
    <div class="philosophy-card">
        <div class="philosophy-close">&times;</div>
        <div class="philo-header">
            <div class="philo-subtitle">About Us</div>
            <h2 class="philo-title">Rediscovering the Lost<br>"TÃ¢i-uÃ¢n BÄ«"</h2>
        </div>
        <div class="philo-body">
            <p>It started with a moment of realization. While hosting international students, I watched them queue endlessly for commercialized "hotspots" and trendy shops. As a local, I found myself unable to share the deeper, authentic stories of my own land.</p>
            <p>It wasn't until a general education class, where a classmate vividly described the very alleys I cycled through every dayâ€”my rental place, the campus cornersâ€”that it hit me: <strong>Taiwan isn't mundane; we've simply lost the energy to explore it amidst our busy lives.</strong></p>
            <div class="philo-highlight">
                "We named this platform TaiwanMe, a play on the pronunciation of å°ç£å‘³ (TÃ¢i-uÃ¢n BÄ«)â€”the true flavor of Taiwan."
            </div>
            <p>Our mission is simple: <strong>The Real Taste of Taiwan.</strong></p>
            <p>You won't find clichÃ© tourist traps here. Instead, we guide you to the authentic scenery hidden in ordinary alleysâ€”stories worth telling. Whether you are a first-time traveler or a long-time resident, we hope to accompany you in finding that unique, irreplaceable Taiwanese sentiment.</p>
        </div>
    </div>
</div>

<div id="searchModal" class="search-modal">
    <div class="close-search" id="closeSearchBtn">&times;</div>
    <div class="search-content">
        <h2>Where to explore?</h2>
        <div class="input-wrapper">
            <input type="text" id="modal-search-input" placeholder="Enter keywords (e.g. Taipei, Food)..." autocomplete="off">
            <button class="submit-search-btn">SEARCH</button>
        </div>
        <div id="modal-results-container" class="search-results-list"></div>
    </div>
</div>

<div class="mobile-drawer-overlay" id="mobileDrawerOverlay"></div>
<div class="mobile-drawer" id="mobileDrawer">
    <div class="drawer-header">
        <span class="drawer-title">MENU</span>
        <button class="drawer-close-btn" id="drawerCloseBtn">&times;</button>
    </div>
    <div class="drawer-content">
        <div class="drawer-section">
            <h3 class="drawer-cat-title">EXPLORE</h3>
            <ul class="drawer-list">
                <li><a href="/souvenirs" class="drawer-link" style="<%= getActiveStyle('souvenirs') %>">Souvenir Guide <span class="arrow">â€º</span></a></li>
                <li><a href="/search_by_city" class="drawer-link" style="<%= getActiveStyle('search_by_city') %>">Search By City <span class="arrow">â€º</span></a></li>
                <li><a href="<%= mapLink %>" class="drawer-link" style="<%= getActiveStyle('hidden_gems') %>">Hidden Gems <span class="arrow">â€º</span></a></li>
                <li><a href="/transport" class="drawer-link" style="<%= getActiveStyle('transport') %>">Transport Guide <span class="arrow">â€º</span></a></li>
                <li><a href="/festivals" class="drawer-link" style="<%= getActiveStyle('festivals') %>">Seasonal Festivals <span class="arrow">â€º</span></a></li>
                <li><a href="/culture" class="drawer-link" style="<%= getActiveStyle('culture') %>">Culture & Daily Life <span class="arrow">â€º</span></a></li>
                <li><a href="/dining" class="drawer-link" style="<%= getActiveStyle('dining') %>">Inclusive Dining <span class="arrow">â€º</span></a></li>
                <li><a href="/entertainment" class="drawer-link" style="<%= getActiveStyle('entertainment') %>">Entertainment <span class="arrow">â€º</span></a></li>
            </ul>
        </div>
        <div class="drawer-section">
            <h3 class="drawer-cat-title">ABOUT TAIWANME</h3>
            <ul class="drawer-list">
                <li><a href="#" class="drawer-link philosophy-trigger">TaiwanMe's Philosophy <span class="arrow">â€º</span></a></li>
                <li><a href="/support" class="drawer-link">Buy Us a Boba <span class="arrow">â€º</span></a></li>
                <li><a href="/contact" class="drawer-link">Business Inquiry <span class="arrow">â€º</span></a></li>
            </ul>
        </div>
    </div>
</div>

<nav class="desktop-nav">
    <ul>
        <li><a href="<%= mapLink %>" style="<%= getActiveStyle('hidden_gems') %>">HIDDEN GEMS</a></li>
        <li><a href="/search_by_city" style="<%= getActiveStyle('search_by_city') %>">SEARCH BY CITY</a></li>
        <li><a href="/festivals" style="<%= getActiveStyle('festivals') %>">SEASONAL FESTIVALS</a></li>
        <li><a href="/transport" style="<%= getActiveStyle('transport') %>">TRANSPORT</a></li>
        <li><a href="/culture" style="<%= getActiveStyle('culture') %>">CULTURE & DAILY LIFE</a></li>
        <li><a href="/dining" style="<%= getActiveStyle('dining') %>">INCLUSIVE DINING</a></li>
        <li><a href="/entertainment" style="<%= getActiveStyle('entertainment') %>">ENTERTAINMENT</a></li>
        <li class="dropdown-item">
            <a href="#" class="dropbtn">MORE â–¾</a>
            <div class="dropdown-content">
                <a href="/souvenirs" style="<%= getActiveStyle('souvenirs') %>">Souvenir Guide</a>
            </div>
        </li>
    </ul>
</nav>

<button id="backToTopBtn" aria-label="Back to Top">â†‘</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // =========================================
    // âœ… é‚è¼¯ä¿®æ­£å€ï¼šHeader å›ºå®š + Nav è‡ªå‹•éš±è—
    // =========================================
    const header = document.getElementById('header'); // ç¬¬ä¸€åˆ— (Logo)
    const nav = document.querySelector('.desktop-nav'); // ç¬¬äºŒåˆ— (å°è¦½åˆ—)
    let lastScrollY = window.scrollY;

    // 1. åˆå§‹åŒ–å®šä½
    function initNavPosition() {
        if(header && nav) {
            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            
            // å¼·åˆ¶è¨­å®š Nav çš„ top ç‚º Header çš„é«˜åº¦ (ç¢ºä¿æ¥åœ¨æ­£ä¸‹æ–¹)
            nav.style.top = headerHeight + 'px';
            
            // è¨­å®š Body çš„ padding-topï¼Œé˜²æ­¢å…§å®¹è¢«é®æ“‹
            document.body.style.paddingTop = (headerHeight + navHeight) + 'px';
        }
    }
    
    // è¦–çª—æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—
    window.addEventListener('resize', initNavPosition);
    // å»¶é²ä¸€ä¸‹ç¢ºä¿æ¨£å¼è¼‰å…¥å®Œç•¢
    setTimeout(initNavPosition, 50);
    initNavPosition();

    // 2. æ²å‹•ç›£è½
    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        
        // æ‰‹æ©Ÿç‰ˆé¸å–®é–‹å•Ÿæ™‚ï¼Œä¸åŸ·è¡Œéš±è—é‚è¼¯
        const mobileDrawer = document.getElementById('mobileDrawer');
        if (mobileDrawer && mobileDrawer.classList.contains('open')) return;

        // åˆ¤æ–·æ²å‹•æ–¹å‘
        if (currentScrollY > lastScrollY && currentScrollY > 20) {
            // å¾€ä¸‹æ²å‹• -> å°è¦½åˆ—å¾€ä¸Šæ”¶ (transform: translateY(-100%))
            // å› ç‚º Nav çš„ top å·²ç¶“è¨­ç‚º Header é«˜åº¦ï¼Œä¸” z-index æ¯” Header ä½
            // æ‰€ä»¥å®ƒæœƒã€Œæ»‘é€²ã€Header çš„èƒŒé¢æ¶ˆå¤±
            nav.classList.add('nav-hidden');
            nav.classList.remove('nav-visible');
        } else {
            // å¾€ä¸Šæ²å‹• -> å°è¦½åˆ—æ»‘å‡º (å›åˆ°åŸä½)
            nav.classList.remove('nav-hidden');
            nav.classList.add('nav-visible');
        }

        lastScrollY = currentScrollY;
    });

    // =========================================
    // å…¶ä»–åŠŸèƒ½ä¿æŒä¸è®Š
    // =========================================
    
    // Back To Top
    const backToTopBtn = document.getElementById('backToTopBtn');
    function calculateThreshold() {
        const h = header ? header.offsetHeight : 0;
        const n = nav ? nav.offsetHeight : 0;
        return (h + n > 0 ? h + n : 150) * 0.5;
    }
    let btnThreshold = calculateThreshold();
    window.addEventListener('scroll', () => {
        if (window.scrollY > btnThreshold) backToTopBtn.classList.add('show');
        else backToTopBtn.classList.remove('show');
    });
    window.addEventListener('resize', () => btnThreshold = calculateThreshold());
    backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // Search Modal
    const searchModal = document.getElementById('searchModal');
    const openBtns = [document.getElementById('desktop-search-trigger'), document.getElementById('mobile-search-trigger')];
    const closeBtn = document.getElementById('closeSearchBtn');
    const input = document.getElementById('modal-search-input');
    const resultsDiv = document.getElementById('modal-results-container');

    openBtns.forEach(btn => {
        if(btn) btn.addEventListener('click', (e) => {
            e.preventDefault();
            searchModal.style.display = 'flex';
            input.value = ''; resultsDiv.innerHTML = '';
            setTimeout(() => input.focus(), 100);
            document.body.style.overflow = 'hidden';
        });
    });

    function closeModal() { searchModal.style.display = 'none'; document.body.style.overflow = ''; }
    if(closeBtn) closeBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if(e.target === searchModal) closeModal(); });

    // Philosophy Modal
    const philoModal = document.getElementById('philosophyModal');
    const philoTriggers = document.querySelectorAll('.philosophy-trigger');
    const philoClose = document.querySelector('.philosophy-close');

    philoTriggers.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            e.preventDefault();
            philoModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            if (mobileDrawer.classList.contains('open')) {
                const drawerCloseBtn = document.getElementById('drawerCloseBtn');
                if(drawerCloseBtn) drawerCloseBtn.click();
            }
        });
    });

    function closePhiloModal() {
        philoModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    if (philoClose) philoClose.addEventListener('click', closePhiloModal);
    window.addEventListener('click', (e) => {
        if (e.target === philoModal) closePhiloModal();
    });

    // Search API
    let timeout = null;
    input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(timeout);
        if (query.length < 1) { resultsDiv.innerHTML = ''; return; }
        timeout = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                renderResults(data);
            } catch (err) { console.error(err); }
        }, 300);
    });

    function renderResults(data) {
        if (data.length === 0) { resultsDiv.innerHTML = '<div style="padding:20px; color:#999;">No results found.</div>'; return; }
        const html = data.map(item => {
            let link = `/search_by_city/${item.citySlug}/${item.id}`;
            if (item.id.startsWith('hg-') || item.folder === 'hiddengems') link = `/hidden_gems/${item.id}`;
            const imgUrl = item.heroImage || '/image/default_thumb.jpg';
            return `
                <a href="${link}" class="result-item" onclick="document.body.style.overflow=''">
                    <img src="${imgUrl}" class="result-img" alt="${item.title}">
                    <div>
                        <div class="result-type">${item.type || 'Article'}</div>
                        <div class="result-title">${item.title}</div>
                    </div>
                </a>`;
        }).join('');
        resultsDiv.innerHTML = html;
    }

    const mobileSearchBtn = document.getElementById('mobile-search-trigger');
    function checkMobile() {
        if(mobileSearchBtn) mobileSearchBtn.style.display = (window.innerWidth <= 900) ? 'block' : 'none';
    }
    window.addEventListener('resize', checkMobile);
    checkMobile();
});
</script>