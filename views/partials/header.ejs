<% 
// --- EJS ÈÇèËºØÂçÄ ---
const getActiveStyle = (targetPage) => {
    return (typeof pageName !== 'undefined' && pageName === targetPage) 
        ? 'color: var(--accent-color); font-weight: bold;' 
        : '';
}
const mapLink = (typeof pageName !== 'undefined' && pageName === 'index') ? '#mapSection' : '/#mapSection';
%>

<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/image/logo.png" type="image/png">
<link rel="apple-touch-icon" href="/image/logo.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "TaiwanMe",
  "alternateName": ["Taiwan Me", "TaiwanMe Travel"],
  "url": "https://taiwanme-dynamic.vercel.app/"
}
</script>

<style>
    /* ========================================= */
    /* 1. Á¨¨‰∏ÄÂàóÔºöLogo ÂçÄ (Ê∞∏ÈÅ†Âõ∫ÂÆö) */
    /* ========================================= */
    .main-header {
        position: fixed; top: 0; left: 0; width: 100%;
        background-color: #fff; z-index: 1002;
        border-bottom: 1px solid #eee;
    }

    /* ========================================= */
    /* 2. Á¨¨‰∫åÂàóÔºöÊô∫ÊÖßÂûãÂ∞éË¶ΩÂàó */
    /* ========================================= */
    .desktop-nav {
        position: fixed; width: 100%; left: 0; z-index: 1001;
        background-color: var(--lace-bg, #F5F3F0); 
        border-top: 2px solid var(--lace-border, #AC9F95);
        border-bottom: 2px solid var(--lace-border, #AC9F95);
        transition: transform 0.3s ease-in-out;
        top: 80px; padding: 5px 0;
    }
    .desktop-nav.nav-hidden { transform: translateY(-100%); }
    .desktop-nav.nav-visible { transform: translateY(0); }

    /* ‰∏ãÊãâÈÅ∏ÂñÆÊ®£Âºè (Dropdown) */
    .dropdown-item { position: relative; cursor: pointer; }
    .dropdown-content {
        display: none; position: absolute; top: 100%; left: 0;
        background-color: var(--lace-bg); min-width: 180px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1); z-index: 105;
        border: 2px solid var(--lace-border); border-top: none;
    }
    .dropdown-content a {
        display: block; padding: 12px 16px; color: #333; text-decoration: none;
        font-size: 0.85rem; font-weight: bold; text-align: left;
        transition: background 0.3s;
    }
    .dropdown-content a:hover { background-color: rgba(255,255,255,0.6); color: var(--accent-color); }
    .dropdown-item:hover .dropdown-content { display: block; }

    /* ========================================= */
    /* 3. È†êÁïôÁ©∫Èñì & ÈÄöÁî®Ê®£Âºè */
    /* ========================================= */
    body { padding-top: 150px; }

    #backToTopBtn {
        position: fixed; bottom: 30px; right: 30px; z-index: 9999;
        width: 50px; height: 50px; border: none; border-radius: 50%;
        background-color: var(--accent-color, #e63946); color: white;
        font-size: 1.5rem; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        opacity: 0; visibility: hidden; transform: translateY(20px);
        transition: all 0.4s ease; display: flex; align-items: center; justify-content: center;
    }
    #backToTopBtn.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #backToTopBtn:hover { background-color: #333; transform: translateY(-5px); }
    @media (max-width: 768px) { #backToTopBtn { bottom: 20px; right: 20px; width: 45px; height: 45px; font-size: 1.2rem; } }

    .search-pill-btn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 20px; margin-left: 20px;
        border: 1px solid #333; border-radius: 50px; background: transparent;
        color: #333; font-weight: bold; font-family: inherit; font-size: 0.85rem;
        cursor: pointer; transition: all 0.3s ease;
        text-transform: uppercase; letter-spacing: 0.05em;
    }
    .search-pill-btn:hover { background: #333; color: #fff; }
    @media (max-width: 900px) { .search-pill-btn { display: none; } }

    .search-modal {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.98);
        z-index: 10000; justify-content: center; align-items: center; flex-direction: column;
        animation: fadeIn 0.3s ease;
    }
    .search-content { text-align: center; width: 100%; max-width: 700px; position: relative; padding: 20px; }
    .search-content h2 { font-size: 2.5rem; color: #333; margin-bottom: 40px; font-family: serif; }
    .input-wrapper { position: relative; display: flex; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
    #modal-search-input { width: 100%; border: none; background: transparent; font-size: 1.5rem; outline: none; color: #333; }
    .submit-search-btn { background: #333; color: white; border: none; padding: 10px 25px; font-size: 1rem; cursor: pointer; text-transform: uppercase; }
    .close-search { position: absolute; top: 30px; right: 40px; font-size: 3rem; cursor: pointer; color: #999; }
    .close-search:hover { color: #333; }
    .search-results-list { margin-top: 20px; text-align: left; max-height: 50vh; overflow-y: auto; }
    .result-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; text-decoration: none; color: #333; transition: background 0.2s; }
    .result-item:hover { background-color: #f9f9f9; }
    .result-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
    .result-type { font-size: 0.75rem; color: #E8A2A2; font-weight: bold; text-transform: uppercase; }
    .result-title { font-size: 1.1rem; font-weight: bold; }

    .philosophy-modal {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(20, 20, 20, 0.9);
        z-index: 10001; justify-content: center; align-items: center;
        animation: fadeIn 0.4s ease; backdrop-filter: blur(5px);
    }
    .philosophy-card {
        background: #fff; width: 90%; max-width: 650px; max-height: 85vh;
        overflow-y: auto; padding: 50px; position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-radius: 4px;
        text-align: left;
    }
    .philosophy-close {
        position: absolute; top: 20px; right: 25px; font-size: 2rem; 
        cursor: pointer; color: #888; transition: color 0.3s; line-height: 1;
    }
    .philosophy-close:hover { color: #000; }
    .philo-header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .philo-title { font-family: serif; font-size: 2.2rem; color: #333; margin-bottom: 10px; line-height: 1.2; }
    .philo-subtitle { font-family: sans-serif; font-size: 0.9rem; color: #E8A2A2; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
    .philo-body p { font-family: sans-serif; font-size: 1.05rem; line-height: 1.8; color: #555; margin-bottom: 20px; }
    .philo-body strong { color: #000; font-weight: 600; }
    .philo-highlight { font-family: serif; font-style: italic; font-size: 1.3rem; color: #333; margin: 30px 0; padding-left: 20px; border-left: 4px solid #E8A2A2; }

    .brand-title-row { display: flex; align-items: baseline; }
    .brand-zh { 
        font-family: 'Noto Serif TC', serif; font-size: 1.15rem; font-weight: 700; margin-left: 10px; color: #333; letter-spacing: 0.1em;
    }
    @media (max-width: 480px) { .brand-zh { display: none; } }
    @media (max-width: 600px) { .philosophy-card { padding: 30px 20px; } .philo-title { font-size: 1.8rem; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<header id="header" class="main-header">
    <div class="header-container">
        <div class="logo">
            <a href="/" class="logo-link">
                <img src="/image/logo.png" alt="TaiwanMe Logo" class="logo-img">
                <div class="logo-text-group">
                    <div class="brand-title-row">
                        <span class="brand-name">TaiwanMe</span>
                        <span class="brand-zh">Âè∞ÁÅ£Âë≥</span>
                    </div>
                    <span class="brand-slogan">THE REAL TASTE OF TAIWAN</span>
                </div>
            </a>
        </div>

        <div class="header-links desktop-only" style="display: flex; align-items: center;">
            <a href="#" class="h-link" id="tippingBtn">BUY US<br>A BOBA</a>
            <a href="#" class="h-link philosophy-trigger" id="philosophyBtn">TAIWANME'S<br>PHILOSOPHY</a>
            <a href="#" class="h-link" id="bizInquiryBtn">BUSINESS<br>INQUIRY</a>
            <button id="desktop-search-trigger" class="search-pill-btn"><span>üîç</span> Search</button>
        </div>

        <div class="nav-icons">
            <button id="mobile-search-trigger" class="search-trigger desktop-hidden" style="background:none; border:none; font-size:1.2rem; cursor:pointer; display:none;">üîç</button>
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu"><span></span><span></span><span></span></button>
        </div>
    </div>
</header>

<div id="philosophyModal" class="philosophy-modal">
    <div class="philosophy-card">
        <div class="philosophy-close">&times;</div>
        <div class="philo-header">
            <div class="philo-subtitle">About Us</div>
            <h2 class="philo-title">Rediscovering the Lost<br>"T√¢i-u√¢n Bƒ´"</h2>
        </div>
        <div class="philo-body">
            <p>It started with a moment of realization. While hosting international students, I watched them queue endlessly for commercialized "hotspots" and trendy shops. As a local, I found myself unable to share the deeper, authentic stories of my own land.</p>
            <p>It wasn't until a general education class, where a classmate vividly described the very alleys I cycled through every day‚Äîmy rental place, the campus corners‚Äîthat it hit me: <strong>Taiwan isn't mundane; we've simply lost the energy to explore it amidst our busy lives.</strong></p>
            <div class="philo-highlight">"We named this platform TaiwanMe, a play on the pronunciation of Âè∞ÁÅ£Âë≥ (T√¢i-u√¢n Bƒ´)‚Äîthe true flavor of Taiwan."</div>
            <p>Our mission is simple: <strong>The Real Taste of Taiwan.</strong></p>
            <p>You won't find clich√© tourist traps here. Instead, we guide you to the authentic scenery hidden in ordinary alleys‚Äîstories worth telling. Whether you are a first-time traveler or a long-time resident, we hope to accompany you in finding that unique, irreplaceable Taiwanese sentiment.</p>
        </div>
    </div>
</div>

<div id="searchModal" class="search-modal">
    <div class="close-search" id="closeSearchBtn">&times;</div>
    <div class="search-content">
        <h2>Where to explore?</h2>
        <div class="input-wrapper">
            <input type="text" id="modal-search-input" placeholder="Enter keywords (e.g. Taipei, Food)..." autocomplete="off">
            <button class="submit-search-btn">SEARCH</button>
        </div>
        <div id="modal-results-container" class="search-results-list"></div>
    </div>
</div>

<div class="mobile-drawer-overlay" id="mobileDrawerOverlay"></div>
<div class="mobile-drawer" id="mobileDrawer">
    <div class="drawer-header">
        <span class="drawer-title">MENU</span>
        <button class="drawer-close-btn" id="drawerCloseBtn">&times;</button>
    </div>
    <div class="drawer-content">
        <div class="drawer-section">
            <h3 class="drawer-cat-title">EXPLORE</h3>
            <ul class="drawer-list">
                <li><a href="/search_by_city" class="drawer-link">Search By City <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="<%= mapLink %>" class="drawer-link">Hidden Gems <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/transport" class="drawer-link">Transport Guide <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/festivals" class="drawer-link">Seasonal Festivals <span class="arrow">‚Ä∫</span></a></li>
            </ul>
        </div>
        <div class="drawer-section">
            <h3 class="drawer-cat-title">LIFESTYLE</h3>
            <ul class="drawer-list">
                <li><a href="/culture" class="drawer-link">Culture & Daily Life <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/dining" class="drawer-link">Inclusive Dining <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/entertainment" class="drawer-link">Entertainment <span class="arrow">‚Ä∫</span></a></li>
            </ul>
        </div>
        <div class="drawer-section">
            <h3 class="drawer-cat-title">STORIES</h3>
            <ul class="drawer-list">
                <li><a href="/blog" class="drawer-link">Uly's Blog <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/souvenirs" class="drawer-link">Souvenir Guide <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="#" class="drawer-link philosophy-trigger">Our Philosophy <span class="arrow">‚Ä∫</span></a></li>
            </ul>
        </div>
    </div>
</div>

<nav class="desktop-nav">
    <ul>
        <li><a href="<%= mapLink %>" style="<%= getActiveStyle('hidden_gems') %>">HIDDEN GEMS</a></li>
        <li><a href="/search_by_city" style="<%= getActiveStyle('search_by_city') %>">SEARCH BY CITY</a></li>
        <li><a href="/festivals" style="<%= getActiveStyle('festivals') %>">SEASONAL FESTIVALS</a></li>
        <li><a href="/transport" style="<%= getActiveStyle('transport') %>">TRANSPORT</a></li>
        <li><a href="/culture" style="<%= getActiveStyle('culture') %>">CULTURE & DAILY LIFE</a></li>
        <li><a href="/dining" style="<%= getActiveStyle('dining') %>">INCLUSIVE DINING</a></li>
        <li><a href="/entertainment" style="<%= getActiveStyle('entertainment') %>">ENTERTAINMENT</a></li>
        <li class="dropdown-item">
            <a href="javascript:void(0)" class="dropbtn">MORE ‚ñæ</a>
            <div class="dropdown-content">
                <a href="/blog" style="<%= getActiveStyle('blog') %>">Uly's Blog</a>
                <a href="/souvenirs" style="<%= getActiveStyle('souvenirs') %>">Souvenir Guide</a>
            </div>
        </li>
    </ul>
</nav>

<button id="backToTopBtn" aria-label="Back to Top">‚Üë</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Header Logic
    const header = document.getElementById('header'); 
    const nav = document.querySelector('.desktop-nav'); 
    let lastScrollY = window.scrollY;

    function initNavPosition() {
        if(header && nav) {
            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            nav.style.top = headerHeight + 'px';
            document.body.style.paddingTop = (headerHeight + navHeight) + 'px';
        }
    }
    window.addEventListener('resize', initNavPosition);
    setTimeout(initNavPosition, 50);
    initNavPosition();

    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        const mobileDrawer = document.getElementById('mobileDrawer');
        if (mobileDrawer && mobileDrawer.classList.contains('open')) return;
        if (currentScrollY > lastScrollY && currentScrollY > 20) {
            nav.classList.add('nav-hidden'); nav.classList.remove('nav-visible');
        } else {
            nav.classList.remove('nav-hidden'); nav.classList.add('nav-visible');
        }
        lastScrollY = currentScrollY;
    });

    // Back To Top
    const backToTopBtn = document.getElementById('backToTopBtn');
    function calculateThreshold() {
        const h = header ? header.offsetHeight : 0;
        const n = nav ? nav.offsetHeight : 0;
        return (h + n > 0 ? h + n : 150) * 0.5;
    }
    let btnThreshold = calculateThreshold();
    window.addEventListener('scroll', () => {
        if (window.scrollY > btnThreshold) backToTopBtn.classList.add('show');
        else backToTopBtn.classList.remove('show');
    });
    window.addEventListener('resize', () => btnThreshold = calculateThreshold());
    backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // Search Modal
    const searchModal = document.getElementById('searchModal');
    const openBtns = [document.getElementById('desktop-search-trigger'), document.getElementById('mobile-search-trigger')];
    const closeBtn = document.getElementById('closeSearchBtn');
    const input = document.getElementById('modal-search-input');
    const resultsDiv = document.getElementById('modal-results-container');

    openBtns.forEach(btn => {
        if(btn) btn.addEventListener('click', (e) => {
            e.preventDefault();
            searchModal.style.display = 'flex';
            input.value = ''; resultsDiv.innerHTML = '';
            setTimeout(() => input.focus(), 100);
            document.body.style.overflow = 'hidden';
        });
    });

    function closeModal() { searchModal.style.display = 'none'; document.body.style.overflow = ''; }
    if(closeBtn) closeBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if(e.target === searchModal) closeModal(); });

    // Philosophy Modal
    const philoModal = document.getElementById('philosophyModal');
    const philoTriggers = document.querySelectorAll('.philosophy-trigger');
    const philoClose = document.querySelector('.philosophy-close');

    philoTriggers.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            e.preventDefault();
            philoModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if (document.getElementById('mobileDrawer').classList.contains('open')) {
                const drawerCloseBtn = document.getElementById('drawerCloseBtn');
                if(drawerCloseBtn) drawerCloseBtn.click();
            }
        });
    });

    function closePhiloModal() { philoModal.style.display = 'none'; document.body.style.overflow = ''; }
    if (philoClose) philoClose.addEventListener('click', closePhiloModal);
    window.addEventListener('click', (e) => { if (e.target === philoModal) closePhiloModal(); });

    // Search API
    let timeout = null;
    input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(timeout);
        if (query.length < 1) { resultsDiv.innerHTML = ''; return; }
        timeout = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                renderResults(data);
            } catch (err) { console.error(err); }
        }, 300);
    });

    function renderResults(data) {
        if (data.length === 0) { resultsDiv.innerHTML = '<div style="padding:20px; color:#999;">No results found.</div>'; return; }
        const html = data.map(item => {
            let link = `/search_by_city/${item.citySlug}/${item.id}`;
            if (item.id.startsWith('hg-') || item.folder === 'hiddengems') link = `/hidden_gems/${item.id}`;
            const imgUrl = item.heroImage || '/image/default_thumb.jpg';
            return `
                <a href="${link}" class="result-item" onclick="document.body.style.overflow=''">
                    <img src="${imgUrl}" class="result-img" alt="${item.title}">
                    <div>
                        <div class="result-type">${item.type || 'Article'}</div>
                        <div class="result-title">${item.title}</div>
                    </div>
                </a>`;
        }).join('');
        resultsDiv.innerHTML = html;
    }

    const mobileSearchBtn = document.getElementById('mobile-search-trigger');
    function checkMobile() {
        if(mobileSearchBtn) mobileSearchBtn.style.display = (window.innerWidth <= 900) ? 'block' : 'none';
    }
    window.addEventListener('resize', checkMobile);
    checkMobile();
});
</script>