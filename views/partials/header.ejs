<% 
// --- EJS ÈÇèËºØÂçÄ ---
const getActiveStyle = (targetPage) => {
    return (typeof pageName !== 'undefined' && pageName === targetPage) 
        ? 'color: var(--accent-color); font-weight: bold;' 
        : '';
}
// Âà§Êñ∑ÊòØÂê¶Âú®È¶ñÈ†ÅÔºåÊ±∫ÂÆöÂú∞ÂúñÈÄ£ÁµêÊòØÈå®Èªû(#)ÈÇÑÊòØË∑ØÂæë(/#)
const mapLink = (typeof pageName !== 'undefined' && pageName === 'index') ? '#mapSection' : '/#mapSection';
%>

<style>
    #backToTopBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999; /* Â±§Á¥öÊúÄÈ´ò */
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background-color: var(--accent-color, #e63946); /* ‰ΩøÁî®ÂÖ®ÂüüËÆäÊï∏ÊàñÁ¥ÖËâ≤ */
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        
        /* Èö±ËóèÁãÄÊÖã */
        opacity: 0; 
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.4s ease;
        
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* È°ØÁ§∫ÁãÄÊÖã (Áî± JS Ê∑ªÂä†) */
    #backToTopBtn.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    #backToTopBtn:hover {
        background-color: #333;
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }

    @media (max-width: 768px) {
        #backToTopBtn {
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
        }
    }
</style>

<header id="header" class="main-header">
    <div class="header-container">
        <div class="logo">
            <a href="/" class="logo-link">
                <img src="/image/logo.png" alt="TaiwanMe Logo" class="logo-img">
                <div class="logo-text-group">
                    <span class="brand-name">TaiwanMe</span>
                    <span class="brand-slogan">THE REAL TASTE OF TAIWAN</span>
                </div>
            </a>
        </div>

        <div class="header-links desktop-only">
            <a href="#" class="h-link" id="tippingBtn">BUY US<br>A BOBA</a>
            <a href="#" class="h-link" id="philosophyBtn">TAIWANME'S<br>PHILOSOPHY</a>
            <a href="#" class="h-link" id="bizInquiryBtn">BUSINESS<br>INQUIRY</a>
        </div>

        <div class="nav-icons">
            <button id="searchBtn" class="search-trigger">üîç <span class="desktop-only">Search</span></button>
            
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
</header>

<div id="searchModal" class="search-modal">
    <div class="close-search">&times;</div>
    <div class="search-content">
        <h2>Where to explore?</h2>
        <input type="text" placeholder="Enter keywords (e.g. Taipei, Food)...">
        <button class="submit-search">Search</button>
    </div>
</div>

<div class="mobile-drawer-overlay" id="mobileDrawerOverlay"></div>
<div class="mobile-drawer" id="mobileDrawer">
    
    <div class="drawer-header">
        <span class="drawer-title">MENU</span>
        <button class="drawer-close-btn" id="drawerCloseBtn">&times;</button>
    </div>

    <div class="drawer-content">
        <div class="drawer-section">
            <h3 class="drawer-cat-title">EXPLORE</h3>
            <ul class="drawer-list">
                <li><a href="/souvenirs" class="drawer-link" style="<%= getActiveStyle('souvenirs') %>">Souvenir Guide <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/search_by_city" class="drawer-link" style="<%= getActiveStyle('search_by_city') %>">Search By City <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="<%= mapLink %>" class="drawer-link" style="<%= getActiveStyle('hidden_gems') %>">Hidden Gems <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/transport" class="drawer-link" style="<%= getActiveStyle('transport') %>">Transport Guide <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/festivals" class="drawer-link" style="<%= getActiveStyle('festivals') %>">Seasonal Festivals <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/culture" class="drawer-link" style="<%= getActiveStyle('culture') %>">Culture & Daily Life <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/dining" class="drawer-link" style="<%= getActiveStyle('dining') %>">Inclusive Dining <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/entertainment" class="drawer-link" style="<%= getActiveStyle('entertainment') %>">Entertainment <span class="arrow">‚Ä∫</span></a></li>
            </ul>
        </div>

        <div class="drawer-section">
            <h3 class="drawer-cat-title">ABOUT TAIWANME</h3>
            <ul class="drawer-list">
                <li><a href="/philosophy" class="drawer-link">TaiwanMe's Philosophy <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/support" class="drawer-link">Buy Us a Boba <span class="arrow">‚Ä∫</span></a></li>
                <li><a href="/contact" class="drawer-link">Business Inquiry <span class="arrow">‚Ä∫</span></a></li>
            </ul>
        </div>
    </div>
</div>

<nav class="desktop-nav">
    <ul>
        <li><a href="<%= mapLink %>" style="<%= getActiveStyle('hidden_gems') %>">HIDDEN GEMS</a></li>
        <li><a href="/search_by_city" style="<%= getActiveStyle('search_by_city') %>">SEARCH BY CITY</a></li>
        <li><a href="/festivals" style="<%= getActiveStyle('festivals') %>">SEASONAL FESTIVALS</a></li>
        <li><a href="/transport" style="<%= getActiveStyle('transport') %>">TRANSPORT</a></li>
        <li><a href="/culture" style="<%= getActiveStyle('culture') %>">CULTURE & DAILY LIFE</a></li>
        <li><a href="/dining" style="<%= getActiveStyle('dining') %>">INCLUSIVE DINING</a></li>
        <li><a href="/entertainment" style="<%= getActiveStyle('entertainment') %>">ENTERTAINMENT</a></li>
        
        <li class="dropdown-item">
            <a href="#" class="dropbtn">MORE ‚ñæ</a>
            <div class="dropdown-content">
                <a href="/souvenirs" style="<%= getActiveStyle('souvenirs') %>">Souvenir Guide</a>
            </div>
        </li>
    </ul>
</nav>

<button id="backToTopBtn" aria-label="Back to Top">‚Üë</button>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const backToTopBtn = document.getElementById('backToTopBtn');
        const header = document.getElementById('header'); // ‰∏äÊñπ Logo ÂçÄÂ°ä
        const nav = document.querySelector('.desktop-nav'); // ‰∏ãÊñπÁÅ∞Ëâ≤Â∞éËà™Âàó

        // Ë®àÁÆóËß∏ÁôºË∑ùÈõ¢
        function calculateThreshold() {
            // ÂèñÂæó Logo ÂçÄÂ°äÈ´òÂ∫¶
            const headerHeight = header ? header.offsetHeight : 0;
            // ÂèñÂæó Nav ÂçÄÂ°äÈ´òÂ∫¶ (Ëã•ÊâãÊ©üÁâàÈö±ËóèÂâáÁÇ∫ 0)
            const navHeight = nav ? nav.offsetHeight : 0;
            
            // Á∏ΩÂ∞éË¶ΩÂàóÈ´òÂ∫¶
            const totalNavHeight = headerHeight + navHeight;

            // Â¶ÇÊûúÁ∏ΩÈ´òÂ∫¶ÁÇ∫ 0 (Ê•µÁ´ØÊÉÖÊ≥Å)ÔºåÁµ¶È†êË®≠ÂÄº 150px
            const baseHeight = totalNavHeight > 0 ? totalNavHeight : 150;

            // Ë®≠ÂÆöËß∏ÁôºÈªûÁÇ∫ÔºöÂ∞éË¶ΩÂàóÁ∏ΩÈ´òÂ∫¶ÁöÑ 0.5 ÂÄç (1/2)
            return baseHeight * 0.5;
        }

        let scrollThreshold = calculateThreshold();

        // Áõ£ËÅΩÊªæÂãï‰∫ã‰ª∂
        window.addEventListener('scroll', () => {
            if (window.scrollY > scrollThreshold) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        // Ë¶ñÁ™óÂ§ßÂ∞èÊîπËÆäÊôÇÈáçÊñ∞Ë®àÁÆó (ÈÅ©Êáâ RWD)
        window.addEventListener('resize', () => {
            scrollThreshold = calculateThreshold();
        });

        // ÈªûÊìäÂõûÂà∞È†ÇÈÉ®
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    });
</script>